services:
  # NATS message queue for worker communication
  nats:
    image: nats:latest
    container_name: unified-workflow-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    command: "-js"
    networks:
      - unified-workflow-network

  # Registry Service
  registry-service:
    build:
      context: .
      dockerfile: Dockerfile.registry
    container_name: unified-workflow-registry
    ports:
      - "8080:8080"
    environment:
      - REGISTRY_PORT=8080
      - LOG_LEVEL=info
    depends_on:
      nats:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - unified-workflow-network

  # Executor Service
  executor-service:
    build:
      context: .
      dockerfile: Dockerfile.executor
    container_name: unified-workflow-executor
    ports:
      - "8081:8081"
    environment:
      - EXECUTOR_PORT=8081
      - REGISTRY_SERVICE_URL=http://registry-service:8080
      - NATS_URL=nats://nats:4222
      - LOG_LEVEL=info
    depends_on:
      registry-service:
        condition: service_healthy
      nats:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - unified-workflow-network


  # Worker Service
  worker-service:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: unified-workflow-worker
    environment:
      - NATS_URL=nats://nats:4222
      - REGISTRY_SERVICE_URL=http://registry-service:8080
      - LOG_LEVEL=info
      - QUEUE_TYPE=nats
    depends_on:
      registry-service:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - unified-workflow-network
    # Worker doesn't expose ports, it only consumes from NATS

  # Test client for workflow lifecycle testing
  test-client:
    image: curlimages/curl:latest
    container_name: unified-workflow-test-client
    depends_on:
      registry-service:
        condition: service_healthy
      executor-service:
        condition: service_healthy
    networks:
      - unified-workflow-network
    command: >
      sh -c "
      echo 'Waiting for services to be ready...' &&
      sleep 30 &&
      echo 'Testing Registry Service...' &&
      curl -f http://registry-service:8080/health &&
      echo '' &&
      echo 'Testing Executor Service...' &&
      curl -f http://executor-service:8081/health &&
      echo '' &&
      echo 'All services are healthy!' &&
      echo '' &&
      echo '=== Workflow Lifecycle Test ===' &&
      echo '1. Creating workflow definition...' &&
      curl -X POST http://registry-service:8080/api/v1/workflows \
        -H 'Content-Type: application/json' \
        -d '{\"name\":\"Test Workflow\",\"description\":\"A test workflow for lifecycle testing\"}' &&
      echo '' &&
      echo '2. Getting workflow definition...' &&
      curl -f http://registry-service:8080/api/v1/workflows &&
      echo '' &&
      echo '3. Testing workflow execution endpoint...' &&
      curl -X POST http://executor-service:8081/api/v1/execute \
        -H 'Content-Type: application/json' \
        -d '{\"workflow_id\":\"test-workflow-1\",\"input_data\":{\"test\":\"data\"}}' &&
      echo '' &&
      echo 'Workflow lifecycle test completed!' &&
      tail -f /dev/null
      "

networks:
  unified-workflow-network:
    driver: bridge

volumes:
  nats-data:
    driver: local
